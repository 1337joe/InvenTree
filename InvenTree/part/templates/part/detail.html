{% extends "part/part_base.html" %}
{% load static %}
{% load i18n %}
{% load markdownify %}


{% block menubar %}
{% include 'part/navbar.html' %}
{% endblock %}

{% block page_content %}

<div class='panel panel-default panel-inventree panel-hidden' id='panel-part-stock'>
    <div class='panel-heading'>
        <h4>{% trans "Part Stock" %}</h4>
    </div>
    <div class='panel-content'>
        {% if part.is_template %}
        <div class='alert alert-info alert-block'>
            {% blocktrans with full_name=part.full_name%}Showing stock for all variants of <i>{{full_name}}</i>{% endblocktrans %}
        </div>
        {% endif %}
        {% include "stock_table.html" %}
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-test-templates'>
    <div class='panel-heading'>
        <h4>{% trans "Part Test Templates" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='test-button-toolbar'>
            <div class='button-toolbar container-fluid' style="float: right;">
                <div class='btn-group' role='group'>
                    <button type='button' class='btn btn-success' id='add-test-template'>{% trans "Add Test Template" %}</button>
                </div>
                <div class='filter-list' id='filter-list-parttests'>
                    <!-- Empty div -->
                </div>
            </div>
        </div>
        
        <table class='table table-striped table-condensed' data-toolbar='#test-button-toolbar' id='test-template-table'></table>        
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-purchase-orders'>
    <div class='panel-heading'>
        <h4>{% trans "Purchase Orders" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='po-button-bar'>
            <div class='button-toolbar container-fluid' style='float: right;'>
                <button class='btn btn-primary' type='button' id='part-order2' title='{% trans "Order part" %}'>
                    <span class='fas fa-shopping-cart'></span> {% trans "Order Part" %}
                </button>
                <div class='filter-list' id='filter-list-purchaseorder'>
                    <!-- An empty div in which the filter list will be constructed -->
                </div>
            </div>
        </div>
        
        <table class='table table-striped table-condensed po-table' id='purchase-order-table' data-toolbar='#po-button-bar'>
        </table>   
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-sales-orders'>
    <div class='panel-heading'>
        <h4>{% trans "Sales Orders" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='so-button-bar'>
            <div class='button-toolbar container-fluid' style='float: right;'>
                {% if 0 %}
                <button class='btn btn-primary' type='button' id='part-order2' title='{% trans "New sales order" %}'>{% trans "New Order" %}</button>
                {% endif %}
                <div class='filter-list' id='filter-list-salesorder'>
                    <!-- An empty div in which the filter list will be constructed -->
                </div>
            </div>
        </div>

        <table class='table table-striped table-condensed po-table' id='sales-order-table' data-toolbar='#so-button-bar'>
        </table>
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-part-notes'>
    <div class='panel-heading'>
        <div class='row'>
            <div class='col-sm-6'>
                <h4>{% trans "Notes" %}</h4>
            </div>
            <div class='col-sm-6'>
                <div class='btn-group float-right'>
                    <button type='button' id='edit-notes' title='{% trans "Edit Notes" %}' class='btn btn-small btn-default'>
                        <span class='fas fa-edit'>      
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class='panel-content'>
        {{ part.notes | markdownify }}
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-variants'>
    <div class='panel-heading'>
        <h4>{% trans "Part Variants" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='variant-button-toolbar'>
            <div class='button-toolbar container-fluid'>
                <div class='btn-group' role='group'>
                    {% if part.is_template and part.active %}
                    <button class='btn btn-success' id='new-variant' title='{% trans "Create new variant" %}'>
                        <span class='fas fa-plus-circle'></span> {% trans "New Variant" %}
                    </button>
                    {% endif %}
                </div>
                <div class='filter-list' id='filter-list-variants'>
                    <!-- Empty div (will be filled out with available BOM filters) -->
                </div>
            </div>
        </div>
        
        <table class='table table-striped table-condensed' id='variants-table' data-toolbar='#variant-button-toolbar'>
        </table>
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-part-parameters'>
    <div class='panel-heading'>
        <h4>{% trans "Parameters" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='param-button-toolbar'>
            <div class='button-toolbar container-fluid' style='float: right;'>
                {% if roles.part.add %}
                <button title='{% trans "Add new parameter" %}' class='btn btn-success' id='param-create'>
                    <span class='fas fa-plus-circle'></span> {% trans "New Parameter" %}
                </button>
                {% endif %}
            </div>
        </div>
        <table id='parameter-table' class='table table-condensed table-striped' data-toolbar="#param-button-toolbar"></table>
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-part-attachments'>
    <div class='panel-heading'>
        <h4>{% trans "Attachments" %}</h4>
    </div>
    <div class='panel-content'>
        {% include "attachment_table.html" %}
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-related-parts'>
    <div class='panel-heading'>
        <h4>{% trans "Related Parts" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='related-button-bar'>
            <div class='button-toolbar container-fluid' style='float: left;'>
                {% if roles.part.change %}
                <button class='btn btn-primary' type='button' id='add-related-part' title='{% trans "Add Related" %}'>{% trans "Add Related" %}</button>
                <div class='filter-list' id='filter-list-related'>
                    <!-- An empty div in which the filter list will be constructed -->
                </div>
                {% endif %}
            </div>
        </div>
        
        <table id='table-related-part' class='table table-condensed table-striped' data-toolbar='#related-button-toolbar'>
            <thead>
                <tr>
                    <th data-field='part' data-serachable='true'>{% trans "Part" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in part.get_related_parts %}
                {% with part_related=item.0 part=item.1 %}
                    <tr>
                        <td>
                            <a class='hover-icon'>
                                <img class='hover-img-thumb' src='{{ part.get_thumbnail_url }}'>
                                <img class='hover-img-large' src='{{ part.get_thumbnail_url }}'>
                            </a>
                            <a href='/part/{{ part.id }}/'>{{ part }}</a>
                            <div class='btn-group' style='float: right;'>
                                {% if roles.part.change %}
                                <button title='{% trans "Delete" %}' class='btn btn-default btn-glyph delete-related-part' url="{% url 'part-related-delete' part_related.id %}" type='button'><span class='fas fa-trash-alt icon-red'/></button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-part-suppliers'>
    <div class='panel-heading'>
        <h4>{% trans "Part Suppliers" %}</h4>
    </div>
    <div class='panel-content'>
        <div id='supplier-button-toolbar'>
            <div class='btn-group'>
                <button class="btn btn-success" id='supplier-create'>
                    <span class='fas fa-plus-circle'></span> {% trans "New Supplier Part" %}
                </button>
                <div id='opt-dropdown' class="btn-group">
                    <button id='supplier-part-options' class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{% trans "Options" %}<span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href='#' id='supplier-part-delete' title='{% trans "Delete supplier parts" %}'>{% trans "Delete" %}</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <table class="table table-striped table-condensed" id='supplier-table' data-toolbar='#supplier-button-toolbar'>
        </table>
    </div>
</div>

<div class='panel panel-default panel-inventree panel-hidden' id='panel-part-manufacturers'>
    <div class='panel-heading'>
        <h4>{% trans "Part Manufacturers" %}</h4>
    </div>
    <div class='panel-content'>
        <div class='panel-content'>
            <div id='manufacturer-button-toolbar'>
                <div class='btn-group'>
                    <button class="btn btn-success" id='manufacturer-create'>
                        <span class='fas fa-plus-circle'></span> {% trans "New Manufacturer Part" %}
                    </button>
                    <div id='opt-dropdown' class="btn-group">
                        <button id='manufacturer-part-options' class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">{% trans "Options" %}<span class="caret"></span></button>
                        <ul class="dropdown-menu">
                            <li><a href='#' id='manufacturer-part-delete' title='{% trans "Delete manufacturer parts" %}'>{% trans "Delete" %}</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <table class='table table-condensed table-striped' id='manufacturer-table' data-toolbar='#manufacturer-button-toolbar'></table>
        </div>
    </div>
</div>

{% endblock %}

{% block js_load %}
{{ block.super }}
{% endblock %}

{% block js_ready %}
    {{ block.super }}

    $('#table-related-part').inventreeTable({
    });

    $("#add-related-part").click(function() {
        launchModalForm("{% url 'part-related-create' %}", {
            data: {
                part: {{ part.id }},
            },
            reload: true,
        });
    });

    $('.delete-related-part').click(function() {
        var button = $(this);

        launchModalForm(button.attr('url'), {
            reload: true,
        });
    });

    loadPartVariantTable($('#variants-table'), {{ part.pk }});

    $('#new-variant').click(function() {
        launchModalForm(
            "{% url 'make-part-variant' part.id %}",
            {
                follow: true,
            }
        );
    });

    loadPurchaseOrderTable($("#purchase-order-table"), {
        url: "{% url 'api-po-list' %}",
        params: {
            part: {{ part.id }},
        },
    });
    
    $("#part-order2").click(function() {
        launchModalForm("{% url 'order-parts' %}", {
            data: {
                part: {{ part.id }},
            },
            reload: true,
        });
    });

    loadSalesOrderTable($("#sales-order-table"), {
        url: "{% url 'api-so-list' %}",
        params: {
            part: {{ part.id }},
        },
    });

    loadPartTestTemplateTable(
        $("#test-template-table"),
        {
            part: {{ part.pk }},
            params: {
                part: {{ part.pk }},
            }
        }
    );
    
    function reloadTable() {
        $("#test-template-table").bootstrapTable("refresh");
    }
    
    $("#add-test-template").click(function() {
    
        constructForm('{% url "api-part-test-template-list" %}', {
            method: 'POST',
            fields: {
                test_name: {},
                description: {},
                required: {},
                requires_value: {},
                requires_attachment: {},
                part: {
                    value: {{ part.pk }},
                    hidden: true,
                }
            },
            title: '{% trans "Add Test Result Template" %}',
            onSuccess: reloadTable
        });
    });
    
    $("#test-template-table").on('click', '.button-test-edit', function() {
        var pk = $(this).attr('pk');
    
        var url = `/api/part/test-template/${pk}/`;
    
        constructForm(url, {
            fields: {
                test_name: {},
                description: {},
                required: {},
                requires_value: {},
                requires_attachment: {},
            },
            title: '{% trans "Edit Test Result Template" %}',
            onSuccess: reloadTable,
        });
    });
    
    $("#test-template-table").on('click', '.button-test-delete', function() {
        var pk = $(this).attr('pk');
    
        var url = `/api/part/test-template/${pk}/`;
    
        constructForm(url, {
            method: 'DELETE',
            title: '{% trans "Delete Test Result Template" %}',
            onSuccess: reloadTable,
        });
    });

    $('#add-stock-item').click(function () {
        createNewStockItem({
            reload: true,
            data: {
                part: {{ part.id }},
            }
        });
    });

    loadStockTable($("#stock-table"), {
        params: {
            part: {{ part.id }},
            location_detail: true,
            part_detail: true,
            supplier_part_detail: true,
        },
        groupByField: 'location',
        buttons: [
            '#stock-options',
        ],
        url: "{% url 'api-stock-list' %}",
    });

    $("#stock-export").click(function() {
        launchModalForm("{% url 'stock-export-options' %}", {
            submit_text: "{% trans 'Export' %}",
            success: function(response) {
                var url = "{% url 'stock-export' %}";

                url += "?format=" + response.format;
                url += "&cascade=" + response.cascade;
                url += "&part={{ part.id }}";

                location.href = url;
            },
        });
    });

    $('#item-create').click(function () {
        createNewStockItem({
            reload: true,
            data: {
                part: {{ part.id }},
            }
        });
    });

    $('#edit-notes').click(function() {
        constructForm('{% url "api-part-detail" part.pk %}', {
            fields: {
                notes: {
                    multiline: true,
                }
            },
            title: '{% trans "Edit Part Notes" %}',
            reload: true,
        });
    });

    $(".slidey").change(function() {
        var field = $(this).attr('fieldname');

        var checked = $(this).prop('checked');

        var data = {};

        data[field] = checked;
        // Update the particular field
        inventreePut("{% url 'api-part-detail' part.id %}",
            data,
            {
                method: 'PATCH',
                reloadOnSuccess: true,
            },
        );
    });

    loadPartParameterTable(
        '#parameter-table', 
        '{% url "api-part-parameter-list" %}',
        {
            params: {
                part: {{ part.pk }},
            }
        }
    );

    $('#param-table').inventreeTable({
    });

    {% if roles.part.add %}
    $('#param-create').click(function() {

        constructForm('{% url "api-part-parameter-list" %}', {
            method: 'POST',
            fields: {
                part: {
                    value: {{ part.pk }},
                    hidden: true,
                },
                template: {},
                data: {},
            },
            title: '{% trans "Add Parameter" %}',
            onSuccess: function() {
                $('#parameter-table').bootstrapTable('refresh');
            }
        });
    });
    {% endif %}

    $('.param-edit').click(function() {
        var button = $(this);

        launchModalForm(button.attr('url'), {
            reload: true,
        });
    });

    $('.param-delete').click(function() {
        var button = $(this);

        launchModalForm(button.attr('url'), {
            reload: true,
        });
    });

    loadAttachmentTable(
        '{% url "api-part-attachment-list" %}',
        {
            filters: {
                part: {{ part.pk }},
            },
            onEdit: function(pk) {
                var url = `/api/part/attachment/${pk}/`;

                constructForm(url, {
                    fields: {
                        comment: {},
                    },
                    title: '{% trans "Edit Attachment" %}',
                    onSuccess: reloadAttachmentTable,
                });
            },
            onDelete: function(pk) {
                var url = `/api/part/attachment/${pk}/`;

                constructForm(url, {
                    method: 'DELETE',
                    confirmMessage: '{% trans "Confirm Delete Operation" %}',
                    title: '{% trans "Delete Attachment" %}',
                    onSuccess: reloadAttachmentTable,
                });
            }
        }
    );

    enableDragAndDrop(
        '#attachment-dropzone',
        '{% url "api-part-attachment-list" %}',
        {
            data: {
                part: {{ part.id }},
            },
            label: 'attachment',
            success: function(data, status, xhr) {
                reloadAttachmentTable();
            }
        }
    );

    $("#new-attachment").click(function() {

        constructForm(
            '{% url "api-part-attachment-list" %}',
            {
                method: 'POST',
                fields: {
                    attachment: {},
                    comment: {},
                    part: {
                        value: {{ part.pk }},
                        hidden: true,
                    }
                },
                onSuccess: reloadAttachmentTable,
                title: '{% trans "Add Attachment" %}',
            }
        )
    });

    attachNavCallbacks({
        name: 'part',
        default: 'part-stock'
    });

    $('#supplier-create').click(function () {
        launchModalForm(
            "{% url 'supplier-part-create' %}",
            {
                reload: true,
                data: {
                    part: {{ part.id }}
                },
                secondary: [
                    {
                        field: 'supplier',
                        label: '{% trans "New Supplier" %}',
                        title: '{% trans "Create new supplier" %}',
                    },
                    {
                        field: 'manufacturer',
                        label: '{% trans "New Manufacturer" %}',
                        title: '{% trans "Create new manufacturer" %}',
                    }
                ]
            });
    });

    $("#supplier-part-delete").click(function() {

        var selections = $("#supplier-table").bootstrapTable("getSelections");

        var parts = [];

        selections.forEach(function(item) {
            parts.push(item.pk);
        });

        launchModalForm("{% url 'supplier-part-delete' %}", {
            data: {
                parts: parts,
            },
            reload: true,
        });
    });

    loadSupplierPartTable(
        "#supplier-table",
        "{% url 'api-supplier-part-list' %}",
        {
            params: {
                part: {{ part.id }},
                part_detail: false,
                supplier_detail: true,
                manufacturer_detail: true,
            },
        }
    );

    linkButtonsToSelection($("#supplier-table"), ['#supplier-part-options']);

    loadManufacturerPartTable(
        '#manufacturer-table',
        "{% url 'api-manufacturer-part-list' %}",
        {
            params: {
                part: {{ part.id }},
                part_detail: true,
                manufacturer_detail: true,
            },
        }
    );

    linkButtonsToSelection($("#manufacturer-table"), ['#manufacturer-part-options']);

    $("#manufacturer-part-delete").click(function() {

        var selections = $("#manufacturer-table").bootstrapTable("getSelections");

        deleteManufacturerParts(selections, {
            onSuccess: function() { 
                $("#manufacturer-table").bootstrapTable("refresh");
            }
        });
    });

    $('#manufacturer-create').click(function () {

        constructForm('{% url "api-manufacturer-part-list" %}', {
            fields: {
                part: {
                    value: {{ part.pk }},
                    hidden: true,
                },
                manufacturer: {},
                MPN: {},
                description: {},
                link: {},
            },
            method: 'POST',
            title: '{% trans "Add Manufacturer Part" %}',
            onSuccess: function() { 
                $("#manufacturer-table").bootstrapTable("refresh");
            }
        });
    });

{% endblock %}
