{% extends "modal_form.html" %}

{% load i18n %}
{% load inventree_extras %}

{% block pre_form_content %}
<table class='table table-striped table-condensed table-price-two'>
    <tr>
        <td><b>{% trans 'Part' %}</b></td>
        <td>{{ part  }}</td>
    </tr>
    <tr>
        <td><b>{% trans 'Quantity' %}</b></td>
        <td>{{ quantity }}</td>
    </tr>
</table>

{% if part.supplier_count > 0 %}
    <h4>{% trans 'Supplier Pricing' %}</h4>
    <table class='table table-striped table-condensed table-price-three'>
    {% if min_total_buy_price %}
    <tr>
        <td><b>{% trans 'Unit Cost' %}</b></td>
        <td>Min: {% include "price.html" with price=min_unit_buy_price %}</td>
        <td>Max: {% include "price.html" with price=max_unit_buy_price %}</td>
    </tr>
    {% if quantity > 1 %}
    <tr>
        <td><b>{% trans 'Total Cost' %}</b></td>
        <td>Min: {% include "price.html" with price=min_total_buy_price %}</td>
        <td>Max: {% include "price.html" with price=max_total_buy_price %}</td>
    </tr>
    {% endif %}
    {% else %}
    <tr>
        <td colspan='3'>
            <span class='warning-msg'><i>{% trans 'No supplier pricing available' %}</i></span>
        </td>
    </tr>
    {% endif %}
    </table>
{% endif %}

{% if part.bom_count > 0 %}
    <h4>{% trans 'BOM Pricing' %}</h4>
    <table class='table table-striped table-condensed table-price-three'>
    {% if min_total_bom_price %}
    <tr>
        <td><b>{% trans 'Unit Cost' %}</b></td>
        <td>Min: {% include "price.html" with price=min_unit_bom_price %}</td>
        <td>Max: {% include "price.html" with price=max_unit_bom_price %}</td>
    </tr>
    {% if quantity > 1 %}
    <tr>
        <td><b>{% trans 'Total Cost' %}</b></td>
        <td>Min: {% include "price.html" with price=min_total_bom_price %}</td>
        <td>Max: {% include "price.html" with price=max_total_bom_price %}</td>
    </tr>
    {% endif %}
    {% if part.has_complete_bom_pricing == False %}
    <tr>
        <td colspan='3'>
            <span class='warning-msg'><i>{% trans 'Note: BOM pricing is incomplete for this part' %}</i></span>
        </td>
    </tr>
    {% endif %}
    {% else %}
    <tr>
        <td colspan='3'>
            <span class='warning-msg'><i>{% trans 'No BOM pricing available' %}</i></span>
        </td>
    </tr>
    {% endif %}
    </table>
{% endif %}

{% if total_part_price %}
    <h4>{% trans 'Sale Price' %}</h4>
    <table class='table table-striped table-condensed table-price-two'>
        <tr>
            <td><b>{% trans 'Unit Cost' %}</b></td>
            <td>{% include "price.html" with price=unit_part_price %}</td>
        </tr>
        <tr>
            <td><b>{% trans 'Total Cost' %}</b></td>
            <td>{% include "price.html" with price=total_part_price %}</td>
        </tr>
    </table>
{% endif %}

    {% if min_unit_buy_price or min_unit_bom_price %}
    {% else %}
        <div class='alert alert-danger alert-block'>
            {% trans 'No pricing information is available for this part.' %}
        </div>
    {% endif %}
    <hr>
{% endblock %}

{% block post_form_content %}
    {% settings_value "INVENTREE_DEFAULT_CURRENCY" as currency %}
    {% settings_value "PART_SHOW_GRAPH" as show_graph %}

    {% if show_graph and price_history %}
        <h4>{% trans 'Stock Pricing' %}</h4>
        {% if price_history|length > 1 %}
            <div style="height: 300px">
                <canvas id="StockPriceChart"></canvas>
            </div>
            <div class='alert alert-info alert-block'>
                {% blocktrans %}All prices are converted from their original currencies to {{currency}} at the current conversion-rate.{% endblocktrans %}
            </div>
            <script>
            var pricedata = {
                    labels: [
                        {% for line in price_history %}'{{ line.date }}',{% endfor %}
                    ],
                    datasets: [{
                        label: '{% trans "Single Price" %}',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgb(255, 99, 132)',
                        yAxisID: 'y',
                        data: [
                            {% for line in price_history %}{{ line.price|stringformat:".2f" }},{% endfor %}
                        ],
                        borderWidth: 1,
                        type: 'line'
                    },
                    {% if 'price_diff' in price_history.0 %}
                    {
                        label: '{% trans "Single Price Difference" %}',
                        backgroundColor: 'rgba(68, 157, 68, 0.2)',
                        borderColor: 'rgb(68, 157, 68)',
                        yAxisID: 'y2',
                        data: [
                            {% for line in price_history %}{{ line.price_diff|stringformat:".2f" }},{% endfor %}
                        ],
                        borderWidth: 1,
                        type: 'line'
                    },
                    {
                        label: '{% trans "Part Single Price" %}',
                        backgroundColor: 'rgba(70, 127, 155, 0.2)',
                        borderColor: 'rgb(70, 127, 155)',
                        yAxisID: 'y',
                        data: [
                            {% for line in price_history %}{{ line.price_part|stringformat:".2f" }},{% endfor %}
                        ],
                        borderWidth: 1,
                        type: 'line'
                    },
                    {% endif %}
                    {
                        label: '{% trans "Quantity" %}',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderColor: 'rgb(255, 206, 86)',
                        yAxisID: 'y1',
                        data: [
                            {% for line in price_history %}{{ line.qty|stringformat:"f" }},{% endfor %}
                        ],
                        borderWidth: 1
                    }]
                }
            var ctx = document.getElementById('StockPriceChart');
            var StockPriceChart = new Chart(ctx, {
                type: 'bar',
                data: pricedata,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {position: 'bottom'}},
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: {display: false},
                            title: {
                                display: true,
                                text: '{% blocktrans %}Single Price - {{currency}}{% endblocktrans %}'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: {display: false},
                            titel: {
                                display: true,
                                text: '{% trans "Quantity" %}',
                                position: 'right'
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'left',
                            grid: {display: false},
                            title: {
                                display: true,
                                text: '{% blocktrans %}Single Price Difference- {{currency}}{% endblocktrans %}'
                            }
                        }
                    },
                }
            });
            </script>
        {% else %}
        <div class='alert alert-danger alert-block'>
            {% trans 'No stock pricing history is available for this part.' %}
        </div>
        {% endif %}
    {% endif %}
{% endblock %}