{% extends "part/part_base.html" %}
{% load static %}

{% block css %}

{% endblock %}

{% block details %}

{% include 'part/tabs.html' with tab='bom' %}

<h3>Bill of Materials{% if editing_enabled %} (Edit Mode){% endif %}</h3>

<table class='table table-striped table-condensed' id='bom-table'>
</table>

<div><br></div>

{% if editing_enabled %}
<div style='float: right;'>
    <button class='btn btn-warning' type='button' id='editing-cancel'>Cancel</button>
    <button class='btn btn-success' type='button' id='editing-finish'>Save Changes</button>
</div>
{% else %}
<div class='dropdown' style="float: right;">
    <button class='btn btn-primary dropdown-toggle' type='button' data-toggle='dropdown'>
        Options
        <span class='caret'></span>
    </button>
    <ul class='dropdown-menu'>
        <li><a href='#' id='edit-bom' title='Edit BOM'>Edit BOM</a></li>
        <li><a href='#' id='export-bom' title='Export BOM'>Export BOM</a></li>
    </ul>
</div>
{% endif %}

{% endblock %}

{% block js_load %}
{{ block.super }}
<script type='text/javascript' src="{% static 'script/inventree/api.js' %}"></script>
<script type='text/javascript' src="{% static 'script/inventree/part.js' %}"></script>
<script type='text/javascript' src="{% static 'script/inventree/bom.js' %}"></script>
{% endblock %}

{% block js_ready %}
{{ block.super }}
    function reloadBom() {
        $("#bom-table").bootstrapTable('refresh');
    }

    // Load the BOM data
    $("#bom-table").bootstrapTable({
        sortable: true,
        search: true,
        queryParams: function(p) {
            return {
                part: {{ part.id }}
            }
        },
        columns: [
            {
                field: 'pk',
                title: 'ID',
                visible: false,
            },
            {
                field: 'sub_part',
                title: 'Part',
                sortable: true,
                formatter: function(value, row, index, field) {
                    return renderLink(value.name, value.url);
                }
            },
            {
                field: 'sub_part.description',
                title: 'Description',
            },
            {
                field: 'quantity',
                title: 'Required',
                searchable: false,
                sortable: true,
                formatter: function(value, row, index, field) {
                    return renderEditable(value,
                                          {
                                             _pk: row.pk,
                                             _title: 'Quantity',
                                             enabled: {{ editing_enabled }},
                                          }
                    );
                }
            },
            {
                field: 'note',
                title: 'Note',
                searchable: true,
                sortable: false,
                formatter: function(value, row, index, field) {
                    return renderEditable(value,
                        {
                            _pk: row.pk,
                            _title: 'Note',
                            _empty: 'Enter note',
                            enabled: {{ editing_enabled }},
                        });
                }
            },
            {
                field: 'sub_part.available_stock',
                title: 'Available',
                searchable: false,
                sortable: true,
                formatter: function(value, row, index, field) {
                    var text = "";
                    if (row.quantity < row.sub_part.available_stock)
                    {
                        text = "<span class='label label-success'>" + value + "</span>";
                    }
                    else
                    {
                        text = "<span class='label label-warning'>" + value + "</span>";
                    }

                    return renderLink(text, row.sub_part.url + "stock/");
                }      
            },
        ],
        url: "{% url 'api-bom-list' %}"
    });

    {% if editing_enabled %}
    $("#editing-finish").click(function() {
        alert("Finished!");
        location.href = "{% url 'part-bom' part.id %}";
    });

    $("#editing-cancel").click(function() {
        alert("Cancelled!");
        location.href = "{% url 'part-bom' part.id %}";
    });

    $("#bom-table").on('load-success.bs.table', function() {
        // Make the table elements editable
        $("#bom-table").find('.editable-item').editable();
    });

    {% else %}

    $("#edit-bom").click(function () {
        
        location.href = "{% url 'part-bom' part.id %}?edit=1";
        
        /*
        editBOM(
            {
                url: "{% url 'api-bom-list' %}",
                part_name: "{{ part.name }}",
                part_id: "{{ part.id }}",
            }
        );
        */
        /*
        launchModalForm(
                        "{% url 'bom-item-create' %}",
                        {
                            reload: true,
                            data: {
                                parent: {{ part.id }}
                            }
                        });
        */
    });

    $("#export-bom").click(function () {
        /*
        launchModalForm(
                        "{% url 'bom-export' part.id %}",
                        {
                        });
        */
        //TODO - Select format of the data
        location.href = "{% url 'bom-export' part.id %}";
    });

    {% endif %}

{% endblock %}