{% extends "base.html" %}
{% load static %}

{% block content %}

<h3>Allocate Parts for Build</h3>

<h4><a href="{% url 'build-detail' build.id %}">{{ build.title }}</a></h4>

<hr>

<table class='table table-striped' id='build-table'>
</table>

{% endblock %}

{% block js_load %}
{{ block.super }}
<script src="{% static 'script/inventree/api.js' %}"></script>
<script src="{% static 'script/inventree/part.js' %}"></script>
<script src="{% static 'script/inventree/build.js' %}"></script>
{% endblock %}

{% block js_ready %}
{{ block.super }}

    function makeInnerTable(pk) {
        var table = "<table class='table table-striped' id='part-table-" + pk + "'></table>";
        return table;
    }

    $('#build-table').bootstrapTable({
        sortable: true,
        detailView: true,
        detailFormatter: function(index, row, element) {
            return makeInnerTable(row.pk);
        },
        onExpandRow: function(index, row, $detail) {
            $('#part-table-' + row.pk).bootstrapTable({
                columns: [
                    {
                        field: 'stock_item_detail.location_name',
                        title: 'Location',
                    },
                    {
                        field: 'stock_item_detail.quantity',
                        title: 'Available',
                    },
                    {
                        field: 'quantity',
                        title: 'Allocated',
                    },
                ],
                url: "/api/build/item/?build={{ build.pk }}&part=" + row.sub_part,
            });
        },
        columns: [
            {
                field: 'sub_part_detail.name',
                title: 'Part',
            },
            {
                title: 'Source',
            },
            {
                field: 'quantity',
                title: 'Quantity',
            },
        ],
    });

    getBomList({part: {{ build.part.id }}}).then(function(response) {
        $("#build-table").bootstrapTable('load', response);
    });

{% endblock %}